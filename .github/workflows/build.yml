name: Build Kiosk OS

on:
  push:
    branches: [master, main]
    tags:
      - 'v*'
  pull_request:
    branches: [master, main]
  workflow_dispatch:
    inputs:
      kiosk_url:
        description: 'Default Kiosk URL'
        required: false
        default: 'https://luxcode.io/'

env:
  BR2_DL_DIR: ${{ github.workspace }}/dl-cache
  BR2_CCACHE_DIR: ${{ github.workspace }}/ccache

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360  # 6 Stunden max

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libncurses5-dev \
            bc \
            flex \
            bison \
            libssl-dev \
            unzip \
            rsync \
            cpio \
            wget \
            file \
            locales \
            ccache \
            python3 \
            python3-pip \
            libelf-dev \
            libgdk-pixbuf2.0-dev \
            imagemagick

          # Generate locales
          sudo locale-gen en_US.UTF-8

      - name: Free up disk space
        run: |
          # Remove unnecessary packages to free space
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache
          df -h

      - name: Cache Buildroot downloads
        uses: actions/cache@v4
        with:
          path: dl-cache
          key: buildroot-dl-${{ hashFiles('configs/kiosk_x86_64_defconfig') }}
          restore-keys: |
            buildroot-dl-

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ccache
          key: buildroot-ccache-${{ github.sha }}
          restore-keys: |
            buildroot-ccache-

      - name: Create cache directories
        run: |
          mkdir -p ${{ env.BR2_DL_DIR }}
          mkdir -p ${{ env.BR2_CCACHE_DIR }}

      - name: Configure Buildroot
        run: |
          make defconfig

          # Enable ccache
          echo "BR2_CCACHE=y" >> buildroot/.config
          echo "BR2_CCACHE_DIR=\"${{ env.BR2_CCACHE_DIR }}\"" >> buildroot/.config

          # Set download directory
          echo "BR2_DL_DIR=\"${{ env.BR2_DL_DIR }}\"" >> buildroot/.config

          # Regenerate config
          make -C buildroot BR2_EXTERNAL=${{ github.workspace }} olddefconfig

      - name: Build Kiosk OS (initial)
        run: |
          # Show config info
          echo "Starting Buildroot build..."
          echo "Download cache: ${{ env.BR2_DL_DIR }}"
          echo "CCCache dir: ${{ env.BR2_CCACHE_DIR }}"

          # Build with parallel jobs
          make -C buildroot BR2_EXTERNAL=${{ github.workspace }} -j$(nproc)

      - name: Build custom splash image
        run: |
          SPLASH_DIR="${{ github.workspace }}/board/kiosk/splash"
          PSPLASH_BUILD="buildroot/output/build/psplash-0.1"

          # Find splash image (png, jpg, or svg)
          SPLASH_IMAGE=""
          for ext in png PNG jpg JPG jpeg JPEG; do
            if [ -f "$SPLASH_DIR/splash.$ext" ]; then
              SPLASH_IMAGE="$SPLASH_DIR/splash.$ext"
              break
            fi
            if [ -f "$SPLASH_DIR/logo.$ext" ]; then
              SPLASH_IMAGE="$SPLASH_DIR/logo.$ext"
              break
            fi
          done

          if [ -z "$SPLASH_IMAGE" ]; then
            echo "No custom splash image found in $SPLASH_DIR"
            echo "To add a custom splash, place splash.png or logo.png in board/kiosk/splash/"
            exit 0
          fi

          echo "Found splash image: $SPLASH_IMAGE"

          if [ ! -d "$PSPLASH_BUILD" ]; then
            echo "psplash build directory not found, skipping custom splash"
            exit 0
          fi

          # Convert to PNG if needed and resize
          TEMP_PNG="/tmp/splash_converted.png"
          convert "$SPLASH_IMAGE" -resize 480x272 -background black -gravity center -extent 480x272 "$TEMP_PNG"

          # Generate psplash header
          cd "$PSPLASH_BUILD"
          gdk-pixbuf-csource --struct --name=PSPLASH_IMG "$TEMP_PNG" > psplash-poky-img.h

          echo "Custom splash image integrated!"

          # Rebuild psplash and regenerate image
          cd ${{ github.workspace }}
          make -C buildroot BR2_EXTERNAL=${{ github.workspace }} psplash-rebuild
          make -C buildroot BR2_EXTERNAL=${{ github.workspace }} -j$(nproc)

      - name: List build artifacts
        run: |
          ls -lah buildroot/output/images/
          echo "---"
          du -sh buildroot/output/images/*

      - name: Prepare release artifact
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          cd buildroot/output/images
          cp rootfs.iso9660 "kiosk-os-${VERSION}.iso"
          sha256sum "kiosk-os-${VERSION}.iso" > "kiosk-os-${VERSION}.iso.sha256"
          echo "RELEASE_VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: kiosk-os-x86_64
          path: buildroot/output/images/rootfs.iso9660
          retention-days: 30
          compression-level: 0

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            buildroot/output/images/kiosk-os-${{ env.RELEASE_VERSION }}.iso
            buildroot/output/images/kiosk-os-${{ env.RELEASE_VERSION }}.iso.sha256
          body: |
            ## Kiosk OS ${{ env.RELEASE_VERSION }}

            ### Download

            Bootbares ISO-Image für USB-Stick oder VM.

            ### Installation

            ```bash
            sudo dd if=kiosk-os-${{ env.RELEASE_VERSION }}.iso of=/dev/sdX bs=4M status=progress
            sync
            ```

            ### Eigene URL verwenden

            Beim Booten im SYSLINUX-Menü Tab drücken und anpassen:
            ```
            kiosk_url=https://deine-url.de
            ```
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Show ccache stats
        run: |
          ccache -s || true
