#!/bin/sh
#
# Kiosk Startup Script
# Called from inittab after system initialization
#

LOG="/var/log/kiosk.log"
exec > "$LOG" 2>&1
set -x  # Enable debug output

echo "=== Kiosk starting at $(date) ==="

# Parse kiosk_url from kernel command line
KIOSK_URL=$(cat /proc/cmdline | tr ' ' '\n' | grep '^kiosk_url=' | sed 's/^kiosk_url=//')

if [ -z "$KIOSK_URL" ]; then
    KIOSK_URL="https://luxcode.io/"
fi

echo "Kiosk URL: $KIOSK_URL"

# Setup environment
export KIOSK_URL
export HOME=/root
export DISPLAY=:0
export XDG_RUNTIME_DIR=/tmp/runtime-root

# Save config for other scripts
echo "KIOSK_URL=\"$KIOSK_URL\"" > /etc/kiosk.conf

# Create runtime directories
mkdir -p /tmp/.X11-unix
mkdir -p "$XDG_RUNTIME_DIR"
chmod 700 "$XDG_RUNTIME_DIR"
chmod 1777 /tmp/.X11-unix

# Check for DRI devices
echo "=== DRI devices ==="
ls -la /dev/dri/ 2>&1 || echo "No /dev/dri"

# Wait for system services
echo "Waiting for system to settle..."
sleep 2

# Kill psplash completely
echo "Stopping psplash..."
killall -9 psplash 2>/dev/null || true
sleep 1

# Switch to tty1
echo "Switching to tty1..."
chvt 1 2>/dev/null || true

# Clear the framebuffer
echo "Clearing screen..."
dd if=/dev/zero of=/dev/fb0 bs=1M count=10 2>/dev/null || true
clear > /dev/tty1 2>/dev/null || true

# Find X server
echo "=== Looking for X server ==="
ls -la /usr/bin/X* 2>&1
ls -la /usr/bin/Xorg 2>&1 || echo "No Xorg"

XSERVER=""
for x in /usr/bin/Xorg /usr/bin/X; do
    if [ -x "$x" ]; then
        XSERVER="$x"
        echo "Using: $x"
        break
    fi
done

if [ -z "$XSERVER" ]; then
    echo "ERROR: No X server found!"
    exec /bin/sh < /dev/tty1 > /dev/tty1 2>&1
fi

# Check for xinit
echo "=== Looking for xinit ==="
ls -la /usr/bin/xinit 2>&1 || echo "No xinit"
ls -la /usr/bin/startx 2>&1 || echo "No startx"

# Start X server
echo "=== Starting X server ==="

# Method: Start X directly in background, then run xinitrc
"$XSERVER" :0 vt1 -nocursor -nolisten tcp -keeptty &
XPID=$!
echo "X server PID: $XPID"

# Wait for X to be ready
echo "Waiting for X server..."
for i in 1 2 3 4 5 6 7 8 9 10; do
    if [ -e /tmp/.X11-unix/X0 ]; then
        echo "X server socket found after ${i}s"
        break
    fi
    sleep 1
done

if [ ! -e /tmp/.X11-unix/X0 ]; then
    echo "ERROR: X server socket not found!"
    echo "=== X log ==="
    cat /var/log/Xorg.0.log 2>&1 | tail -50
    kill $XPID 2>/dev/null
    exec /bin/sh < /dev/tty1 > /dev/tty1 2>&1
fi

# Check if X is still running
if ! kill -0 $XPID 2>/dev/null; then
    echo "ERROR: X server died!"
    echo "=== X log ==="
    cat /var/log/Xorg.0.log 2>&1 | tail -50
    exec /bin/sh < /dev/tty1 > /dev/tty1 2>&1
fi

echo "X server running successfully"

# Now run the xinitrc
echo "=== Starting xinitrc ==="
export DISPLAY=:0
exec /etc/X11/xinit/xinitrc
