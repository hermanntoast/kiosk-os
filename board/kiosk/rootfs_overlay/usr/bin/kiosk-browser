#!/bin/sh
#
# Chromium Kiosk Browser Launcher
#

# Load URL from environment or config
if [ -z "$KIOSK_URL" ] && [ -f /etc/kiosk.conf ]; then
    . /etc/kiosk.conf
fi

# Fallback URL
if [ -z "$KIOSK_URL" ]; then
    KIOSK_URL="https://luxcode.io/"
fi

# Find Chromium binary
CHROMIUM=""
for c in /usr/bin/chromium /usr/bin/chromium-browser /usr/local/bin/chromium; do
    if [ -x "$c" ]; then
        CHROMIUM="$c"
        break
    fi
done

if [ -z "$CHROMIUM" ]; then
    echo "ERROR: Chromium not found!"
    echo "Available browsers:"
    ls -la /usr/bin/*chrom* 2>/dev/null || echo "  none"
    ls -la /usr/bin/*firefox* 2>/dev/null || echo "  none"
    echo "Falling back to xterm..."
    exec xterm -e "echo 'Chromium not found. URL: $KIOSK_URL'; sh"
fi

echo "Starting browser: $CHROMIUM"
echo "URL: $KIOSK_URL"

# Create temp directory for Chromium profile
CHROMIUM_DIR="/tmp/chromium-kiosk"
mkdir -p "$CHROMIUM_DIR"

# Infinite loop to restart browser if it crashes
while true; do
    # Clear old data on each start
    rm -rf "$CHROMIUM_DIR"/* 2>/dev/null

    $CHROMIUM \
        --kiosk \
        --no-first-run \
        --no-default-browser-check \
        --disable-translate \
        --disable-infobars \
        --disable-session-crashed-bubble \
        --disable-features=TranslateUI \
        --noerrdialogs \
        --disable-pinch \
        --overscroll-history-navigation=0 \
        --start-fullscreen \
        --disable-restore-session-state \
        --disable-breakpad \
        --disable-hang-monitor \
        --disable-client-side-phishing-detection \
        --disable-component-update \
        --disable-background-networking \
        --disable-sync \
        --disable-default-apps \
        --disable-extensions \
        --disable-popup-blocking \
        --autoplay-policy=no-user-gesture-required \
        --user-data-dir="$CHROMIUM_DIR" \
        --window-position=0,0 \
        --no-sandbox \
        --disable-gpu \
        --disable-software-rasterizer \
        "$KIOSK_URL"

    # Brief pause before restart
    echo "Browser exited, restarting in 2 seconds..."
    sleep 2
done
