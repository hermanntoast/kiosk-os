#!/bin/sh
#
# Kiosk X11 Session
#

exec >> /var/log/kiosk.log 2>&1
echo "=== xinitrc starting ==="

# Load kiosk URL from config
if [ -f /etc/kiosk.conf ]; then
    . /etc/kiosk.conf
fi

# Fallback URL
if [ -z "$KIOSK_URL" ]; then
    KIOSK_URL="https://luxcode.io/"
fi

export KIOSK_URL
export DISPLAY=:0
export HOME=/root

echo "DISPLAY=$DISPLAY"
echo "KIOSK_URL=$KIOSK_URL"

# Set keyboard layout (German)
setxkbmap de 2>/dev/null || echo "setxkbmap failed"

# Disable screen saver and power management
xset s off 2>/dev/null || echo "xset s off failed"
xset s noblank 2>/dev/null || echo "xset s noblank failed"
xset -dpms 2>/dev/null || echo "xset -dpms failed"

# Set background to black
xsetroot -solid black 2>/dev/null || echo "xsetroot failed"

# Test X is working
echo "Testing X with xdpyinfo..."
xdpyinfo > /dev/null 2>&1 && echo "X is working!" || echo "X test failed!"

# Wait a moment
sleep 2

# Start D-Bus session bus (required for Chromium)
echo "Starting D-Bus..."
if [ -z "$DBUS_SESSION_BUS_ADDRESS" ]; then
    eval $(dbus-launch --sh-syntax 2>&1)
    export DBUS_SESSION_BUS_ADDRESS
    echo "DBUS_SESSION_BUS_ADDRESS=$DBUS_SESSION_BUS_ADDRESS"
fi

# Execute the kiosk browser
echo "=== Starting kiosk-browser ==="
exec /usr/bin/kiosk-browser
