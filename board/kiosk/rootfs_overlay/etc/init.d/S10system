#!/bin/sh
#
# Basic system setup for Kiosk OS
#

case "$1" in
    start)
        echo "Setting up system..."

        # Create required directories
        mkdir -p /var/run /var/lock /var/log /var/tmp
        mkdir -p /tmp/.X11-unix
        chmod 1777 /tmp/.X11-unix
        chmod 1777 /tmp

        # Setup /dev/shm if not mounted
        if ! mountpoint -q /dev/shm; then
            mkdir -p /dev/shm
            mount -t tmpfs tmpfs /dev/shm
        fi

        # Create device nodes if missing (for initramfs)
        [ -e /dev/null ] || mknod -m 666 /dev/null c 1 3
        [ -e /dev/zero ] || mknod -m 666 /dev/zero c 1 5
        [ -e /dev/random ] || mknod -m 666 /dev/random c 1 8
        [ -e /dev/urandom ] || mknod -m 666 /dev/urandom c 1 9
        [ -e /dev/tty ] || mknod -m 666 /dev/tty c 5 0
        [ -e /dev/tty1 ] || mknod -m 620 /dev/tty1 c 4 1
        [ -e /dev/console ] || mknod -m 600 /dev/console c 5 1

        # Load kernel modules for graphics
        echo "Loading graphics modules..."
        modprobe drm 2>/dev/null || true
        modprobe drm_kms_helper 2>/dev/null || true

        # VM graphics
        modprobe virtio-gpu 2>/dev/null || true
        modprobe virtio_gpu 2>/dev/null || true
        modprobe bochs-drm 2>/dev/null || true
        modprobe bochs_drm 2>/dev/null || true
        modprobe cirrus 2>/dev/null || true
        modprobe qxl 2>/dev/null || true
        modprobe vmwgfx 2>/dev/null || true
        modprobe vboxvideo 2>/dev/null || true

        # Real hardware
        modprobe i915 2>/dev/null || true
        modprobe nouveau 2>/dev/null || true
        modprobe radeon 2>/dev/null || true
        modprobe amdgpu 2>/dev/null || true

        # Framebuffer fallback
        modprobe simpledrm 2>/dev/null || true

        # Wait for devices to appear
        sleep 1

        # Show what we got
        echo "DRM devices:"
        ls -la /dev/dri/ 2>/dev/null || echo "  No DRI devices found"

        # Load input modules
        modprobe evdev 2>/dev/null || true
        modprobe usbhid 2>/dev/null || true

        echo "System setup complete."
        ;;
    stop)
        ;;
    *)
        echo "Usage: $0 {start|stop}"
        exit 1
        ;;
esac

exit 0
