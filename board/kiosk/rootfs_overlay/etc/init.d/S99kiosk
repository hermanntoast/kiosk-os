#!/bin/sh
#
# Kiosk Browser Startup Script
#

PIDFILE=/var/run/kiosk.pid
KIOSK_USER=root

start() {
    printf "Starting kiosk: "

    # Parse kiosk_url from kernel command line
    KIOSK_URL=$(cat /proc/cmdline | tr ' ' '\n' | grep '^kiosk_url=' | sed 's/^kiosk_url=//')

    # Default URL if not specified
    if [ -z "$KIOSK_URL" ]; then
        KIOSK_URL="https://luxcode.io/"
    fi

    # Export for xinitrc
    echo "KIOSK_URL=\"$KIOSK_URL\"" > /etc/kiosk.conf

    # Wait for display devices
    sleep 2

    # Stop splash screen before starting X
    /usr/bin/psplash-write "QUIT" 2>/dev/null || true
    killall psplash 2>/dev/null || true
    sleep 0.5

    # Start X server with kiosk browser
    /sbin/start-stop-daemon -S -b -m -p $PIDFILE \
        -x /usr/bin/startx -- -nocursor vt7 &

    echo "OK"
}

stop() {
    printf "Stopping kiosk: "
    /sbin/start-stop-daemon -K -p $PIDFILE
    killall Xorg 2>/dev/null
    killall chromium 2>/dev/null
    echo "OK"
}

restart() {
    stop
    sleep 1
    start
}

case "$1" in
    start)
        start
        ;;
    stop)
        stop
        ;;
    restart|reload)
        restart
        ;;
    *)
        echo "Usage: $0 {start|stop|restart}"
        exit 1
esac

exit $?
